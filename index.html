<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ENGLISH KILLER WEB</title>
  <style>
body {
  background: linear-gradient(135deg, #1e3c72, #2a5298);
  color: #fff;
  font-family: 'Segoe UI', sans-serif;
  text-align: center;
  min-height: 100vh;
  margin: 0;
}
.animated-title {
  font-size: 3em;
  margin-top: 2em;
  animation: bounce 2s infinite;
}
@keyframes bounce {
  0%, 100% { transform: translateY(0);}
  50% { transform: translateY(-20px);}
}
.button-container {
  margin-top: 3em;
}
button {
  background: #fff;
  color: #2a5298;
  border: none;
  padding: 1em 2em;
  margin: 1em;
  font-size: 1.2em;
  border-radius: 10px;
  cursor: pointer;
  transition: background 0.3s, color 0.3s, transform 0.2s;
}
button:hover {
  background: #2a5298;
  color: #fff;
  transform: scale(1.1);
}
input, select {
  padding: 0.7em;
  border-radius: 8px;
  border: none;
  margin: 0.5em 0;
  width: 80%;
  max-width: 350px;
  font-size: 1em;
}
.form-container {
  background: rgba(255,255,255,0.1);
  border-radius: 15px;
  padding: 2em;
  margin: 2em auto;
  width: 90%;
  max-width: 400px;
  box-shadow: 0 8px 32px 0 rgba(31,38,135,0.37);
}
.link {
  color: #fff;
  text-decoration: underline;
  cursor: pointer;
}
.card {
  background: rgba(255,255,255,0.15);
  border-radius: 12px;
  margin: 1em auto;
  padding: 1em;
  max-width: 600px;
  box-shadow: 0 4px 16px 0 rgba(31,38,135,0.17);
}
.admin-section {
  margin: 2em 0;
  padding: 1em;
  background: rgba(255,255,255,0.08);
  border-radius: 10px;
}
input[type="file"] {
  background: #fff;
  color: #2a5298;
}
  </style>
</head>
<body>
  <div id="app"></div>
  <script>
// ========== CONFIG ==========
const API_KEY = "$2a$10$En69WYD5e.SZpM5aUICUaeHcOPLP3XAMkf1OkDgcVSxSMgMNqleYC";
const BIN_USERS = "689f6021ae596e708fcace20";
const BIN_MCQ = "689f606fd0ea881f405a019d";
const BIN_MATERIALS = "689f6094ae596e708fcace6f";
const BIN_ZOOM = "689f60caae596e708fcace93";
const BASE_URL = "https://api.jsonbin.io/v3/b/";

// ========== UTILS ==========
function getBinUrl(bin) {
  return BASE_URL + bin;
}
function getHeaders() {
  return {
    "Content-Type": "application/json",
    "X-Master-Key": API_KEY
  };
}
function showMsg(id, msg, color="lime") {
  const el = document.getElementById(id);
  if (el) {
    el.innerHTML = `<span style="color:${color};">${msg}</span>`;
    setTimeout(() => { el.innerHTML = ""; }, 3000);
  }
}
function setPage(page) {
  window.location.hash = page;
  renderPage();
}
function getUser() {
  try {
    return JSON.parse(localStorage.getItem("ekweb_user"));
  } catch { return null; }
}
function logout() {
  localStorage.removeItem("ekweb_user");
  setPage('');
}

// ========== PAGES ==========
function renderPage() {
  const hash = window.location.hash.replace('#','');
  const user = getUser();
  if (!hash || hash === "index") return renderIndex();
  if (hash === "login") return renderLogin();
  if (hash === "register") return renderRegister();
  if (hash === "admin" && user && user.role === "admin") return renderAdmin();
  if (hash === "user" && user && user.role === "user") return renderUser();
  if (hash === "mcq" && user && user.role === "user") return renderMcq();
  if (hash === "study" && user) return renderStudy();
  // fallback
  renderIndex();
}

function renderIndex() {
  document.getElementById("app").innerHTML = `
    <h1 class="animated-title">ENGLISH KILLER WEB</h1>
    <div class="button-container">
      <button onclick="setPage('login')">Login as User</button>
      <button onclick="setPage('login')">Login as Admin</button>
    </div>
  `;
}

function renderLogin() {
  document.getElementById("app").innerHTML = `
    <h1>Login</h1>
    <div class="form-container">
      <form id="loginForm">
        <input type="text" id="loginUsername" placeholder="Username" required><br>
        <input type="password" id="loginPassword" placeholder="Password" required><br>
        <button type="submit">Login</button>
      </form>
      <div style="margin-top:1em;">
        <span class="link" onclick="setPage('register')">Create Account</span>
      </div>
      <div id="loginMsg"></div>
    </div>
  `;
  document.getElementById("loginForm").onsubmit = async function(e) {
    e.preventDefault();
    const username = document.getElementById("loginUsername").value.trim();
    const password = document.getElementById("loginPassword").value.trim();
    showMsg("loginMsg", "Logging in...", "yellow");
    const res = await fetch(getBinUrl(BIN_USERS) + "/latest", { headers: getHeaders() });
    const data = await res.json();
    const users = data.record;
    const user = users.find(u => u.username === username && u.password === password);
    if (user) {
      localStorage.setItem("ekweb_user", JSON.stringify(user));
      setPage(user.role === "admin" ? "admin" : "user");
    } else {
      showMsg("loginMsg", "Invalid credentials!", "red");
    }
  };
}

function renderRegister() {
  document.getElementById("app").innerHTML = `
    <h1>Register</h1>
    <div class="form-container">
      <form id="registerForm">
        <input type="text" id="registerUsername" placeholder="Username" required><br>
        <input type="password" id="registerPassword" placeholder="Password" required><br>
        <button type="submit">Register</button>
      </form>
      <div style="margin-top:1em;">
        <span class="link" onclick="setPage('login')">Back to Login</span>
      </div>
      <div id="registerMsg"></div>
    </div>
  `;
  document.getElementById("registerForm").onsubmit = async function(e) {
    e.preventDefault();
    const username = document.getElementById("registerUsername").value.trim();
    const password = document.getElementById("registerPassword").value.trim();
    if (!username || !password) return;
    showMsg("registerMsg", "Registering...", "yellow");
    const res = await fetch(getBinUrl(BIN_USERS) + "/latest", { headers: getHeaders() });
    const data = await res.json();
    const users = data.record;
    if (users.find(u => u.username === username)) {
      showMsg("registerMsg", "Username already exists!", "red");
      return;
    }
    const newUser = { id: Date.now(), username, password, role: "user" };
    users.push(newUser);
    await fetch(getBinUrl(BIN_USERS), {
      method: "PUT",
      headers: getHeaders(),
      body: JSON.stringify(users)
    });
    showMsg("registerMsg", "Registered! Please login.", "lime");
    setTimeout(() => { setPage('login'); }, 1500);
  };
}

function renderAdmin() {
  document.getElementById("app").innerHTML = `
    <h1>Admin Dashboard</h1>
    <div class="admin-section">
      <h2>Zoom Meeting Link</h2>
      <form id="zoomForm">
        <input type="text" id="zoomLink" placeholder="Zoom Meeting Link" required>
        <button type="submit">Update Link</button>
      </form>
      <div id="zoomMsg"></div>
    </div>
    <div class="admin-section">
      <h2>MCQ Management</h2>
      <form id="mcqForm">
        <input type="text" id="mcqQuestion" placeholder="Question" required><br>
        <input type="text" id="mcqOption0" placeholder="Option 1" required><br>
        <input type="text" id="mcqOption1" placeholder="Option 2" required><br>
        <input type="text" id="mcqOption2" placeholder="Option 3" required><br>
        <input type="text" id="mcqOption3" placeholder="Option 4" required><br>
        <select id="mcqAnswer" required>
          <option value="">Correct Option</option>
          <option value="0">Option 1</option>
          <option value="1">Option 2</option>
          <option value="2">Option 3</option>
          <option value="3">Option 4</option>
        </select><br>
        <button type="submit">Add MCQ</button>
      </form>
      <div id="mcqMsg"></div>
      <div id="mcqList"></div>
    </div>
    <div class="admin-section">
      <h2>Study Materials</h2>
      <form id="materialForm">
        <input type="text" id="materialTitle" placeholder="Title" required><br>
        <input type="text" id="materialUrl" placeholder="PDF URL" required><br>
        <button type="submit">Add Material</button>
      </form>
      <div id="materialMsg"></div>
      <div id="materialList"></div>
    </div>
    <div class="admin-section">
      <h2>All Users</h2>
      <div id="userList"></div>
    </div>
    <div style="margin:2em;">
      <button onclick="logout()">Logout</button>
    </div>
  `;
  // Zoom link
  document.getElementById("zoomForm").onsubmit = async function(e) {
    e.preventDefault();
    const link = document.getElementById("zoomLink").value.trim();
    await fetch(getBinUrl(BIN_ZOOM), {
      method: "PUT",
      headers: getHeaders(),
      body: JSON.stringify({ link })
    });
    showMsg("zoomMsg", "Zoom link updated!");
  };
  (async function() {
    const res = await fetch(getBinUrl(BIN_ZOOM) + "/latest", { headers: getHeaders() });
    const data = await res.json();
    document.getElementById("zoomLink").value = data.record.link || "";
  })();
  // MCQ Management
  async function loadMcqs() {
    const res = await fetch(getBinUrl(BIN_MCQ) + "/latest", { headers: getHeaders() });
    const data = await res.json();
    const mcqs = data.record;
    let html = "";
    mcqs.forEach((q, i) => {
      html += `<div class="card">
        <b>Q${i+1}:</b> ${q.question}<br>
        <ol type="A">${q.options.map((o, idx) => `<li${q.answer==idx?' style=\"color:lime;\"':''}>${o}</li>`).join("")}</ol>
        <button onclick="deleteMcq(${q.id})">Delete</button>
      </div>`;
    });
    document.getElementById("mcqList").innerHTML = html || "No MCQs yet.";
  }
  window.deleteMcq = async function(id) {
    const res = await fetch(getBinUrl(BIN_MCQ) + "/latest", { headers: getHeaders() });
    const data = await res.json();
    let mcqs = data.record;
    mcqs = mcqs.filter(q => q.id !== id);
    await fetch(getBinUrl(BIN_MCQ), {
      method: "PUT",
      headers: getHeaders(),
      body: JSON.stringify(mcqs)
    });
    loadMcqs();
  };
  document.getElementById("mcqForm").onsubmit = async function(e) {
    e.preventDefault();
    const question = document.getElementById("mcqQuestion").value.trim();
    const options = [
      document.getElementById("mcqOption0").value.trim(),
      document.getElementById("mcqOption1").value.trim(),
      document.getElementById("mcqOption2").value.trim(),
      document.getElementById("mcqOption3").value.trim()
    ];
    const answer = parseInt(document.getElementById("mcqAnswer").value);
    if (!question || options.some(o=>!o) || isNaN(answer)) return;
    const res = await fetch(getBinUrl(BIN_MCQ) + "/latest", { headers: getHeaders() });
    const data = await res.json();
    const mcqs = data.record;
    mcqs.push({ id: Date.now(), question, options, answer });
    await fetch(getBinUrl(BIN_MCQ), {
      method: "PUT",
      headers: getHeaders(),
      body: JSON.stringify(mcqs)
    });
    showMsg("mcqMsg", "MCQ added!");
    loadMcqs();
    e.target.reset();
  };
  loadMcqs();
  // Study Materials
  async function loadMaterials() {
    const res = await fetch(getBinUrl(BIN_MATERIALS) + "/latest", { headers: getHeaders() });
    const data = await res.json();
    const materials = data.record;
    let html = "";
    materials.forEach((m, i) => {
      html += `<div class="card">
        <b>${m.title}</b> <a href="${m.url}" target="_blank" style="color:yellow;">[Download]</a>
        <button onclick="deleteMaterial(${m.id})">Delete</button>
      </div>`;
    });
    document.getElementById("materialList").innerHTML = html || "No materials yet.";
  }
  window.deleteMaterial = async function(id) {
    const res = await fetch(getBinUrl(BIN_MATERIALS) + "/latest", { headers: getHeaders() });
    const data = await res.json();
    let materials = data.record;
    materials = materials.filter(m => m.id !== id);
    await fetch(getBinUrl(BIN_MATERIALS), {
      method: "PUT",
      headers: getHeaders(),
      body: JSON.stringify(materials)
    });
    loadMaterials();
  };
  document.getElementById("materialForm").onsubmit = async function(e) {
    e.preventDefault();
    const title = document.getElementById("materialTitle").value.trim();
    const url = document.getElementById("materialUrl").value.trim();
    if (!title || !url) return;
    const res = await fetch(getBinUrl(BIN_MATERIALS) + "/latest", { headers: getHeaders() });
    const data = await res.json();
    const materials = data.record;
    materials.push({ id: Date.now(), title, url });
    await fetch(getBinUrl(BIN_MATERIALS), {
      method: "PUT",
      headers: getHeaders(),
      body: JSON.stringify(materials)
    });
    showMsg("materialMsg", "Material added!");
    loadMaterials();
    e.target.reset();
  };
  loadMaterials();
  // User List
  async function loadUsers() {
    const res = await fetch(getBinUrl(BIN_USERS) + "/latest", { headers: getHeaders() });
    const data = await res.json();
    const users = data.record;
    let html = "<ul>";
    users.forEach(u => {
      html += `<li>${u.username} (${u.role})</li>`;
    });
    html += "</ul>";
    document.getElementById("userList").innerHTML = html;
  }
  loadUsers();
}

function renderUser() {
  document.getElementById("app").innerHTML = `
    <h1>Welcome to ENGLISH KILLER WEB</h1>
    <div class="card">
      <h2>Join Zoom Meeting</h2>
      <a id="zoomJoin" href="#" target="_blank">Loading...</a>
    </div>
    <div class="card">
      <h2>MCQ Test</h2>
      <button onclick="setPage('mcq')">Start Test</button>
    </div>
    <div class="card">
      <h2>Study Materials</h2>
      <div id="userMaterialList"></div>
    </div>
    <div style="margin:2em;">
      <button onclick="logout()">Logout</button>
    </div>
  `;
  (async function() {
    const res = await fetch(getBinUrl(BIN_ZOOM) + "/latest", { headers: getHeaders() });
    const data = await res.json();
    document.getElementById("zoomJoin").href = data.record.link || "#";
    document.getElementById("zoomJoin").innerText = data.record.link ? "Join Meeting" : "No link set";
  })();
  (async function() {
    const res = await fetch(getBinUrl(BIN_MATERIALS) + "/latest", { headers: getHeaders() });
    const data = await res.json();
    const materials = data.record;
    let html = "";
    materials.forEach(m => {
      html += `<div><b>${m.title}</b> <a href="${m.url}" target="_blank" style="color:yellow;">[Download]</a></div>`;
    });
    document.getElementById("userMaterialList").innerHTML = html || "No materials yet.";
  })();
}

function renderMcq() {
  document.getElementById("app").innerHTML = `
    <h1>MCQ Test</h1>
    <div id="mcqTest"></div>
    <div style="margin:2em;">
      <button onclick="setPage('user')">Back to Dashboard</button>
    </div>
  `;
  (async function() {
    const res = await fetch(getBinUrl(BIN_MCQ) + "/latest", { headers: getHeaders() });
    const data = await res.json();
    const mcqs = data.record;
    let current = 0, score = 0;
    const mcqTest = document.getElementById("mcqTest");
    function showQ() {
      if (current >= mcqs.length) {
        mcqTest.innerHTML = `<h2>Test Complete!</h2><p>Your Score: ${score} / ${mcqs.length}</p>`;
        return;
      }
      const q = mcqs[current];
      mcqTest.innerHTML = `
        <div class="card">
          <b>Q${current+1}:</b> ${q.question}<br>
          <ol type="A">
            ${q.options.map((o, i) => `<li><button onclick="answerQ(${i})">${o}</button></li>`).join("")}
          </ol>
        </div>
      `;
    }
    window.answerQ = function(i) {
      if (mcqs[current].answer === i) score++;
      current++;
      showQ();
    };
    showQ();
  })();
}

function renderStudy() {
  document.getElementById("app").innerHTML = `
    <h1>Study Materials</h1>
    <div id="studyMaterialList"></div>
    <div style="margin:2em;">
      <button onclick="setPage('user')">Back to Dashboard</button>
    </div>
  `;
  (async function() {
    const res = await fetch(getBinUrl(BIN_MATERIALS) + "/latest", { headers: getHeaders() });
    const data = await res.json();
    const materials = data.record;
    let html = "";
    materials.forEach(m => {
      html += `<div class="card"><b>${m.title}</b> <a href="${m.url}" target="_blank" style="color:yellow;">[Download]</a></div>`;
    });
    document.getElementById("studyMaterialList").innerHTML = html || "No materials yet.";
  })();
}

// ========== INIT ==========
window.setPage = setPage;
window.logout = logout;
window.deleteMcq = function(){}; // placeholder
window.deleteMaterial = function(){}; // placeholder
window.answerQ = function(){}; // placeholder
window.addEventListener('hashchange', renderPage);
renderPage();
  </script>
</body>
</html>
